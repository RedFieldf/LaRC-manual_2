<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>研究テーマ管理</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, orderBy, query } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // 既存の設定を使用
        const firebaseConfig = {
            apiKey: "AIzaSyAU02VkWid0YqFxj2t7saBfmTH7oEYOshc",
            authDomain: "cell-manual.firebaseapp.com",
            projectId: "cell-manual",
            storageBucket: "cell-manual.firebasestorage.app",
            messagingSenderId: "488469326630",
            appId: "1:488469326630:web:5703fe9fc84fb1c64a6fe7",
            measurementId: "G-9MC4FZXEEH"
        };

        // updateDoc を追加して公開
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, orderBy, query };
        
        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.appId = "cell-manual-reservation"; 
    </script>

    <style>
        body { background-color: #f3f4f6; font-family: "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // 管理者削除用パスワード（ハッシュ値: "cell"）
        const ADMIN_HASH = "0ee90d89ff7e29bd4950bab53abba1cfd82ff2edd27151e48725b614f1b21643";

        async function sha256(text) {
            const uint8 = new TextEncoder().encode(text);
            const digest = await crypto.subtle.digest('SHA-256', uint8);
            return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- 学年計算ロジック ---
        const calculateGrade = (entryYear) => {
            const today = new Date();
            const currentFiscalYear = today.getMonth() + 1 < 4 ? today.getFullYear() - 1 : today.getFullYear();
            const diff = currentFiscalYear - entryYear;

            if (diff < 0) return "未来";
            if (diff === 0) return "B1";
            if (diff === 1) return "B2";
            if (diff === 2) return "B3";
            if (diff === 3) return "B4";
            if (diff === 4) return "M1";
            if (diff === 5) return "M2";
            if (diff >= 6) return `D${diff - 5}`;
            return "";
        };

        // --- カテゴリ定義 ---
        const CATEGORIES = [
            { id: 'cardiomyocyte', name: '心筋', color: 'red', bg: 'bg-red-100', text: 'text-red-700', border: 'border-red-200' },
            { id: 'neuron', name: '神経', color: 'green', bg: 'bg-green-100', text: 'text-green-700', border: 'border-green-200' },
            { id: 'liposome', name: 'リポソーム', color: 'yellow', bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-200' }
        ];

        // --- アイコン ---
        const IconBack = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 18l-6-6 6-6"/></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const IconUser = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        // ★ 編集アイコン追加
        const IconEdit = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;

        // --- App Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [themes, setThemes] = useState([]);
            const [loading, setLoading] = useState(true);
            
            // モーダル関連
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [deleteTarget, setDeleteTarget] = useState(null);
            const [deletePassword, setDeletePassword] = useState("");

            // ★ 編集ターゲットState追加
            const [editTarget, setEditTarget] = useState(null);

            // 入力フォーム
            const [inputName, setInputName] = useState("");
            const [inputYear, setInputYear] = useState(new Date().getFullYear() - 3); // デフォルトはB4想定
            const [inputTheme, setInputTheme] = useState("");
            // 複数選択用に配列に変更。初期値として心筋を選択状態にしておく
            const [inputCategories, setInputCategories] = useState(["cardiomyocyte"]); 

            // 1. Firebase ログイン監視
            useEffect(() => {
                const { signInAnonymously, onAuthStateChanged } = window.firebaseModules;
                signInAnonymously(window.auth).catch(e => console.error("Auth Error:", e));

                const unsubscribe = onAuthStateChanged(window.auth, (u) => {
                    setUser(u);
                    if (u) {
                        const savedName = localStorage.getItem('my_name_theme');
                        if (savedName) setInputName(savedName);
                    }
                });
                return () => unsubscribe();
            }, []);

            // 2. データ監視
            useEffect(() => {
                if (!user) return;
                setLoading(true);

                const { collection, query, orderBy, onSnapshot } = window.firebaseModules;
                const q = query(
                    collection(window.db, 'artifacts', window.appId, 'public', 'data', 'theme_data'),
                    orderBy('year', 'asc') // 入学年度順
                );

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setThemes(data);
                    setLoading(false);
                }, (error) => {
                    console.error("DB Error:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            // データを年度ごとにグループ化
            const groupedThemes = useMemo(() => {
                const groups = {};
                themes.forEach(item => {
                    const y = item.year;
                    if (!groups[y]) groups[y] = [];
                    groups[y].push(item);
                });
                return Object.keys(groups).sort((a, b) => a - b).map(year => ({
                    year: year,
                    grade: calculateGrade(year),
                    items: groups[year]
                }));
            }, [themes]);

            // カテゴリ選択のトグル処理
            const handleCategoryToggle = (catId) => {
                setInputCategories(prev => {
                    if (prev.includes(catId)) {
                        return prev.filter(id => id !== catId);
                    } else {
                        return [...prev, catId];
                    }
                });
            };

            // ★ モーダルを開く処理（新規・編集共通）
            const openModal = (item = null) => {
                if (item) {
                    // 編集モード
                    setEditTarget(item);
                    setInputName(item.name);
                    setInputYear(item.year);
                    setInputTheme(item.theme);
                    // カテゴリの復元（後方互換対応）
                    setInputCategories(item.categories || (item.category ? [item.category] : ["cardiomyocyte"]));
                } else {
                    // 新規モード
                    setEditTarget(null);
                    // 名前と年度はリセットせず前回の入力を残す（便利なので）
                    setInputTheme("");
                    setInputCategories(["cardiomyocyte"]);
                }
                setIsAddModalOpen(true);
            };

            // ★ 送信処理（新規・更新分岐）
            const handleSubmit = async () => {
                if (!inputName.trim()) return alert("名前を入力してください");
                if (!inputTheme.trim()) return alert("テーマを入力してください");
                if (inputCategories.length === 0) return alert("カテゴリを少なくとも1つ選択してください");
                
                localStorage.setItem('my_name_theme', inputName);

                const { collection, addDoc, updateDoc, doc } = window.firebaseModules;
                
                const saveData = {
                    year: Number(inputYear),
                    name: inputName,
                    theme: inputTheme,
                    categories: inputCategories, // 配列として保存
                    uid: user.uid,
                    updatedAt: new Date().toISOString()
                };

                try {
                    if (editTarget) {
                        // 更新
                        await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'theme_data', editTarget.id), saveData);
                    } else {
                        // 新規
                        saveData.createdAt = new Date().toISOString();
                        await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'theme_data'), saveData);
                    }
                    setIsAddModalOpen(false);
                    setInputTheme(""); // テーマだけリセット
                } catch (e) {
                    console.error(e);
                    alert("保存に失敗しました");
                }
            };

            // 削除処理
            const handleDeleteClick = (item) => {
                setDeleteTarget(item);
                setDeletePassword("");
                
                if (item.uid === user.uid) {
                    if (confirm("このデータを削除しますか？")) executeDelete(item.id);
                } else {
                    setIsDeleteModalOpen(true);
                }
            };

            const executeDelete = async (docId) => {
                const { doc, deleteDoc } = window.firebaseModules;
                try {
                    await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'theme_data', docId));
                    setIsDeleteModalOpen(false);
                    setDeleteTarget(null);
                } catch (e) {
                    alert("削除に失敗しました");
                }
            };

            const handleAdminDelete = async () => {
                const hash = await sha256(deletePassword);
                if (hash === ADMIN_HASH) executeDelete(deleteTarget.id);
                else alert("パスワードが違います");
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-lg overflow-hidden flex flex-col relative">
                    
                    {/* ヘッダー */}
                    <div className="bg-purple-700 text-white p-4 flex items-center shadow-md shrink-0 z-20">
                        <a href="index.html" className="mr-3 p-2 hover:bg-purple-600 rounded-full transition">
                            <IconBack />
                        </a>
                        <h1 className="font-bold text-lg">研究テーマ管理</h1>
                    </div>

                    {/* メインコンテンツ */}
                    <div className="flex-1 p-4 overflow-y-auto bg-gray-50 pb-24">
                        {loading ? <div className="text-center py-10 text-gray-400">読み込み中...</div> : (
                            <div className="space-y-6">
                                {groupedThemes.length === 0 && (
                                    <div className="text-center py-10 text-gray-400">
                                        <p>登録データがありません</p>
                                        <p className="text-sm">右下のボタンから登録してください</p>
                                    </div>
                                )}
                                
                                {groupedThemes.map(group => (
                                    <div key={group.year} className="animate-fade-in">
                                        <div className="flex items-center gap-2 mb-2 px-1">
                                            <span className="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-bold">{group.year}年度入学</span>
                                            <span className="text-sm font-bold text-gray-500">({group.grade})</span>
                                        </div>
                                        <div className="space-y-3">
                                            {group.items.map(item => {
                                                const isMine = user && item.uid === user.uid;
                                                
                                                // カテゴリの配列を取得（過去データ互換：categoriesがない場合はcategoryを使用）
                                                const itemCategories = item.categories || (item.category ? [item.category] : []);

                                                return (
                                                    <div key={item.id} className={`bg-white p-4 rounded-xl shadow-sm border-l-4 ${isMine ? 'border-purple-500' : 'border-gray-300'} relative`}>
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex flex-col gap-1">
                                                                <div className="flex items-center gap-2 text-gray-800">
                                                                    <IconUser />
                                                                    <span className="font-bold text-lg">{item.name}</span>
                                                                    {isMine && <span className="text-[10px] bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full">あなた</span>}
                                                                </div>
                                                                {/* カテゴリバッジ一覧 */}
                                                                <div className="flex flex-wrap gap-1 mt-1">
                                                                    {itemCategories.map(catId => {
                                                                        const cat = CATEGORIES.find(c => c.id === catId);
                                                                        if (!cat) return null;
                                                                        return (
                                                                            <span key={cat.id} className={`text-[10px] px-1.5 py-0.5 rounded border font-bold ${cat.bg} ${cat.text} ${cat.border}`}>
                                                                                {cat.name}
                                                                            </span>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                {/* ★ 編集ボタン（自分の投稿のみ） */}
                                                                {isMine && (
                                                                    <button onClick={() => openModal(item)} className="text-gray-300 hover:text-blue-500 p-1">
                                                                        <IconEdit />
                                                                    </button>
                                                                )}
                                                                <button onClick={() => handleDeleteClick(item)} className="text-gray-300 hover:text-red-500 p-1">
                                                                    <IconTrash />
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div className="text-sm text-gray-700 bg-gray-50 p-3 rounded-lg whitespace-pre-wrap leading-relaxed">
                                                            {item.theme}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* 追加ボタン */}
                    <button 
                        onClick={() => openModal()}
                        className="fixed bottom-6 right-6 w-14 h-14 bg-purple-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-purple-700 transition active:scale-95 z-30"
                    >
                        <IconPlus />
                    </button>

                    {/* --- 追加・編集モーダル --- */}
                    {isAddModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                                <h3 className="text-xl font-bold mb-4 text-gray-800 border-b pb-2">
                                    {editTarget ? "テーマ編集" : "テーマ登録"}
                                </h3>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">大学入学年度 (西暦)</label>
                                        <div className="flex items-center gap-2">
                                            <input type="number" value={inputYear} onChange={e => setInputYear(e.target.value)} className="w-full p-2 border rounded bg-gray-50" placeholder="2022" />
                                            <span className="text-sm text-purple-600 font-bold w-20 text-center">{calculateGrade(inputYear)}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">名前 (苗字)</label>
                                        <input type="text" value={inputName} onChange={e => setInputName(e.target.value)} className="w-full p-2 border rounded bg-gray-50" placeholder="例: 佐藤" />
                                    </div>

                                    {/* カテゴリ選択 (チェックボックス・複数選択) */}
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">研究カテゴリ (複数選択可)</label>
                                        <div className="flex gap-2 flex-wrap">
                                            {CATEGORIES.map(cat => {
                                                const isChecked = inputCategories.includes(cat.id);
                                                return (
                                                    <label key={cat.id} className={`flex-1 min-w-[80px] py-2 px-1 text-center text-sm rounded border cursor-pointer transition-colors ${
                                                        isChecked 
                                                        ? `bg-${cat.color}-500 text-white border-${cat.color}-500 font-bold shadow-md` 
                                                        : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'
                                                    }`}>
                                                        <input 
                                                            type="checkbox" 
                                                            value={cat.id} 
                                                            checked={isChecked} 
                                                            onChange={() => handleCategoryToggle(cat.id)} 
                                                            className="hidden"
                                                        />
                                                        {isChecked && <span className="mr-1">✓</span>}
                                                        {cat.name}
                                                    </label>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">テーマ・概要</label>
                                        <textarea value={inputTheme} onChange={e => setInputTheme(e.target.value)} className="w-full p-2 border rounded bg-gray-50 h-32 resize-none" placeholder="研究内容を記入してください"></textarea>
                                    </div>
                                </div>

                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setIsAddModalOpen(false)} className="flex-1 py-3 bg-gray-200 text-gray-700 font-bold rounded-lg">キャンセル</button>
                                    <button onClick={handleSubmit} className="flex-1 py-3 bg-purple-600 text-white font-bold rounded-lg shadow">
                                        {editTarget ? "更新する" : "登録する"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- 管理者削除モーダル --- */}
                    {isDeleteModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in">
                            <div className="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl text-center">
                                <h3 className="text-lg font-bold text-red-600 mb-2">管理者削除</h3>
                                <p className="text-sm text-gray-600 mb-4">他人のデータを削除するには<br/>管理者パスワードが必要です。</p>
                                <input 
                                    type="password" 
                                    value={deletePassword} 
                                    onChange={e => setDeletePassword(e.target.value)} 
                                    className="w-full p-2 border rounded mb-4" 
                                    placeholder="Password"
                                />
                                <div className="flex gap-2">
                                    <button onClick={() => setIsDeleteModalOpen(false)} className="flex-1 py-2 bg-gray-200 rounded text-sm font-bold">キャンセル</button>
                                    <button onClick={handleAdminDelete} className="flex-1 py-2 bg-red-600 text-white rounded text-sm font-bold">削除</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

